#!/bin/bash
# ApocalypseOS — Encrypted backup using BorgBackup
set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

if [ "$(id -u)" -ne 0 ]; then
    echo -e "${RED}Error: Must run as root (sudo apos-backup /path/to/backup)${NC}"
    exit 1
fi

REPO="${1:-/mnt/backup/apocalypseos}"
KEY_FILE="/root/.config/apos-backup-key"

if ! command -v borg &>/dev/null; then
    echo -e "${RED}Error: borgbackup is not installed.${NC}"
    exit 1
fi

# Initialize on first run
if [ ! -f "$KEY_FILE" ]; then
    echo -e "${YELLOW}First backup — generating encryption key...${NC}"
    mkdir -p "$(dirname "$KEY_FILE")"
    head -c 64 /dev/urandom | base64 > "$KEY_FILE"
    chmod 600 "$KEY_FILE"

    echo -e "${YELLOW}Initializing backup repository at $REPO${NC}"
    mkdir -p "$REPO"
    BORG_PASSCOMMAND="cat $KEY_FILE" borg init --encryption=repokey "$REPO"

    echo ""
    echo -e "${RED}IMPORTANT: Back up your encryption key!${NC}"
    echo -e "${RED}Key location: $KEY_FILE${NC}"
    echo -e "${RED}Without this key, your backups cannot be restored.${NC}"
    echo -e "${RED}Copy it to a safe location (e.g., printed paper, separate USB).${NC}"
    echo ""
fi

BACKUP_NAME="backup-$(date +%Y%m%d-%H%M%S)"

echo -e "${GREEN}=== ApocalypseOS Backup ===${NC}"
echo "Repository: $REPO"
echo "Backup name: $BACKUP_NAME"
echo ""

BORG_PASSCOMMAND="cat $KEY_FILE" borg create \
    --verbose \
    --stats \
    --compression zstd,6 \
    --exclude '/dev/*' \
    --exclude '/proc/*' \
    --exclude '/sys/*' \
    --exclude '/tmp/*' \
    --exclude '/run/*' \
    --exclude '/mnt/*' \
    --exclude '/media/*' \
    --exclude '/lost+found' \
    --exclude '/swapfile' \
    --exclude '/var/cache/*' \
    --exclude '/var/tmp/*' \
    "$REPO::$BACKUP_NAME" /

echo ""
echo -e "${GREEN}Backup complete. Pruning old backups...${NC}"

BORG_PASSCOMMAND="cat $KEY_FILE" borg prune \
    --verbose \
    --stats \
    --keep-daily 7 \
    --keep-weekly 4 \
    --keep-monthly 6 \
    "$REPO"

echo ""
echo -e "${GREEN}=== Backup finished ===${NC}"
echo "To list backups: BORG_PASSCOMMAND='cat $KEY_FILE' borg list $REPO"
echo "To restore: sudo apos-restore $REPO"
