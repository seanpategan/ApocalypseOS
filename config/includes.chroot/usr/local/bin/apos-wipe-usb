#!/bin/bash
# ApocalypseOS — Securely wipe a USB drive so data cannot be recovered
set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

if [ "$(id -u)" -ne 0 ]; then
    echo -e "${RED}Error: Must run as root (sudo apos-wipe-usb)${NC}"
    exit 1
fi

echo -e "${RED}============================================${NC}"
echo -e "${RED}     ApocalypseOS — Secure USB Wipe         ${NC}"
echo -e "${RED}============================================${NC}"
echo ""
echo -e "${RED}WARNING: This will PERMANENTLY DESTROY all data on the selected drive.${NC}"
echo -e "${RED}The data will NOT be recoverable.${NC}"
echo ""

# List available drives
echo -e "${BLUE}Available drives:${NC}"
echo ""
lsblk -d -o NAME,SIZE,MODEL,TRAN | grep -E 'usb|NAME'
echo ""

read -p "Enter device to wipe (e.g., sdb): " DEVICE

if [ -z "$DEVICE" ]; then
    echo -e "${RED}No device specified. Aborting.${NC}"
    exit 1
fi

DEVPATH="/dev/$DEVICE"

if [ ! -b "$DEVPATH" ]; then
    echo -e "${RED}Error: $DEVPATH is not a valid block device.${NC}"
    exit 1
fi

# Safety check — don't wipe the root disk
ROOT_DISK=$(lsblk -no PKNAME "$(findmnt -no SOURCE /)" 2>/dev/null || echo "sda")
if [ "$DEVICE" = "$ROOT_DISK" ]; then
    echo -e "${RED}Error: $DEVPATH appears to be your system disk. Aborting.${NC}"
    exit 1
fi

# Show drive info
echo ""
echo -e "${YELLOW}Drive to wipe:${NC}"
lsblk -o NAME,SIZE,MODEL,MOUNTPOINT "$DEVPATH"
echo ""

echo -e "${RED}This will:${NC}"
echo "  1. Unmount all partitions on $DEVPATH"
echo "  2. Overwrite the entire drive with random data (pass 1)"
echo "  3. Overwrite the entire drive with zeros (pass 2)"
echo "  4. Overwrite with random data again (pass 3)"
echo "  5. Destroy the partition table"
echo ""

read -p "Type 'WIPE' to confirm destruction of ALL data on $DEVPATH: " CONFIRM

if [ "$CONFIRM" != "WIPE" ]; then
    echo "Aborted."
    exit 0
fi

echo ""

# Unmount all partitions
echo -e "${BLUE}[1/5] Unmounting partitions...${NC}"
for part in "${DEVPATH}"*; do
    umount "$part" 2>/dev/null || true
done

DRIVE_SIZE=$(blockdev --getsize64 "$DEVPATH")
DRIVE_SIZE_HR=$(numfmt --to=iec "$DRIVE_SIZE")

# Pass 1: Random data
echo -e "${BLUE}[2/5] Writing random data (pass 1 of 3)... Size: $DRIVE_SIZE_HR${NC}"
dd if=/dev/urandom of="$DEVPATH" bs=4M status=progress 2>&1 || true

# Pass 2: Zeros
echo -e "${BLUE}[3/5] Writing zeros (pass 2 of 3)...${NC}"
dd if=/dev/zero of="$DEVPATH" bs=4M status=progress 2>&1 || true

# Pass 3: Random data again
echo -e "${BLUE}[4/5] Writing random data (pass 3 of 3)...${NC}"
dd if=/dev/urandom of="$DEVPATH" bs=4M status=progress 2>&1 || true

# Destroy partition table
echo -e "${BLUE}[5/5] Destroying partition table...${NC}"
wipefs -a "$DEVPATH" 2>/dev/null || true
dd if=/dev/zero of="$DEVPATH" bs=512 count=2048 2>/dev/null || true

echo ""
echo -e "${GREEN}============================================${NC}"
echo -e "${GREEN}     Secure wipe complete                   ${NC}"
echo -e "${GREEN}============================================${NC}"
echo ""
echo "  Device: $DEVPATH"
echo "  Method: 3-pass overwrite (random, zero, random) + partition table destroyed"
echo "  Data recovery: NOT POSSIBLE"
echo ""
echo "  To reuse this drive, create a new partition table:"
echo "    fdisk $DEVPATH"
echo "    mkfs.ext4 ${DEVPATH}1"
