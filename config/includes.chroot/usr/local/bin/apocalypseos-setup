#!/bin/bash
# ApocalypseOS — First-boot setup wizard
# Detects hardware, installs Ollama models, then locks down wireless permanently
set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

if [ "$(id -u)" -ne 0 ]; then
    echo -e "${RED}Error: Must run as root (sudo apocalypseos-setup)${NC}"
    exit 1
fi

echo ""
echo -e "${GREEN}============================================${NC}"
echo -e "${GREEN}     ApocalypseOS — First-Time Setup        ${NC}"
echo -e "${GREEN}============================================${NC}"
echo ""
echo -e "${YELLOW}Wi-Fi is temporarily enabled for this setup.${NC}"
echo -e "${YELLOW}After setup completes, wireless will be permanently disabled.${NC}"
echo ""

# --- Phase 1: Temporarily enable wireless ---
echo -e "${BLUE}[1/5] Enabling wireless temporarily...${NC}"
rfkill unblock all 2>/dev/null || true
modprobe cfg80211 2>/dev/null || true
modprobe iwlwifi 2>/dev/null || true
sleep 2

# Attempt to connect to Wi-Fi
echo ""
echo "Available Wi-Fi networks:"
nmcli device wifi list 2>/dev/null || echo "  (No Wi-Fi adapter found — skipping network setup)"
echo ""
read -p "Enter Wi-Fi network name (SSID), or 'skip' to continue offline: " SSID

if [ "$SSID" != "skip" ] && [ -n "$SSID" ]; then
    read -sp "Enter Wi-Fi password: " WIFI_PASS
    echo ""
    nmcli device wifi connect "$SSID" password "$WIFI_PASS" 2>/dev/null || {
        echo -e "${RED}Failed to connect. Continuing offline.${NC}"
    }
    sleep 3
fi

# --- Phase 2: Hardware detection ---
echo ""
echo -e "${BLUE}[2/5] Detecting hardware...${NC}"

RAM_GB=$(free -g | awk '/Mem:/{print $2}')
CPU_MODEL=$(grep -m1 'model name' /proc/cpuinfo | cut -d: -f2 | xargs)
CPU_CORES=$(nproc)
DISK_FREE=$(df -BG / | awk 'NR==2{print int($4)}')
HAS_NVIDIA=$(lspci 2>/dev/null | grep -ci 'nvidia' || true)
HAS_AMD_GPU=$(lspci 2>/dev/null | grep -ci 'amd.*radeon\|amd.*navi\|amd.*vega' || true)
HAS_GPU=$((HAS_NVIDIA + HAS_AMD_GPU))

echo "  CPU:       $CPU_MODEL ($CPU_CORES cores)"
echo "  RAM:       ${RAM_GB}GB"
echo "  Free Disk: ${DISK_FREE}GB"
if [ "$HAS_NVIDIA" -gt 0 ]; then
    echo "  GPU:       NVIDIA detected"
elif [ "$HAS_AMD_GPU" -gt 0 ]; then
    echo "  GPU:       AMD detected"
else
    echo "  GPU:       None (CPU inference only)"
fi

# --- Phase 3: Ollama installation and model recommendations ---
echo ""
echo -e "${BLUE}[3/5] Installing Ollama...${NC}"

if command -v ollama &>/dev/null; then
    echo "  Ollama already installed."
else
    if ping -c 1 ollama.com &>/dev/null 2>&1; then
        curl -fsSL https://ollama.com/install.sh | sh
        echo "  Ollama installed successfully."
    else
        echo -e "${YELLOW}  No internet connection. Skipping Ollama install.${NC}"
        echo "  You can install Ollama later from a USB drive."
    fi
fi

if command -v ollama &>/dev/null; then
    echo ""
    echo -e "${GREEN}=== Recommended Local AI Models ===${NC}"
    echo ""

    if [ "$RAM_GB" -ge 32 ] && [ "$HAS_GPU" -gt 0 ]; then
        echo "  Your hardware is powerful. Recommended models:"
        echo "    1) llama3:70b      — Most capable, ~40GB disk"
        echo "    2) codellama:34b   — Code generation specialist"
        echo "    3) llama3:8b       — Fast general-purpose"
        echo "    4) mistral:7b      — Efficient all-rounder"
    elif [ "$RAM_GB" -ge 16 ]; then
        echo "  Your hardware is good. Recommended models:"
        echo "    1) llama3:8b       — Good balance of speed and quality"
        echo "    2) codellama:7b    — Code assistance"
        echo "    3) mistral:7b      — General-purpose"
        echo "    4) phi3:mini       — Lightweight alternative"
    elif [ "$RAM_GB" -ge 8 ]; then
        echo "  Your hardware is moderate. Recommended models:"
        echo "    1) phi3:mini       — Lightweight, good quality"
        echo "    2) tinyllama       — Minimal resource usage"
        echo "    3) codellama:7b    — Code help (may be slow)"
    else
        echo "  Your hardware is limited. Recommended models:"
        echo "    1) tinyllama       — Minimal resources required"
        echo "    2) phi3:mini       — Lightweight alternative"
    fi

    echo ""
    read -p "Enter model names to download (space-separated), or 'skip': " MODELS

    if [ "$MODELS" != "skip" ] && [ -n "$MODELS" ]; then
        # Start ollama service if not running
        systemctl start ollama 2>/dev/null || ollama serve &>/dev/null &
        sleep 2

        for model in $MODELS; do
            echo ""
            echo -e "${BLUE}Downloading $model...${NC}"
            ollama pull "$model" || echo -e "${RED}Failed to pull $model${NC}"
        done
    fi
fi

# --- Phase 4: Disconnect and lock down wireless ---
echo ""
echo -e "${BLUE}[4/5] Locking down wireless interfaces...${NC}"

# Disconnect Wi-Fi
nmcli device disconnect wlan0 2>/dev/null || true
nmcli radio wifi off 2>/dev/null || true

# Block all wireless via rfkill
rfkill block all

# Disable wireless services
systemctl disable --now wpa_supplicant 2>/dev/null || true
systemctl disable --now bluetooth 2>/dev/null || true

# Enable the lockdown service for future boots
systemctl enable apocalypseos-lockdown.service 2>/dev/null || true

echo "  All wireless interfaces disabled."
echo "  Wireless module blacklist active at /etc/modprobe.d/disable-wireless.conf"

# --- Phase 5: Firewall ---
echo ""
echo -e "${BLUE}[5/5] Configuring firewall...${NC}"

ufw --force reset >/dev/null 2>&1
ufw default deny incoming
ufw default deny outgoing
ufw --force enable

echo "  Firewall active: all incoming and outgoing traffic denied."

# --- Done ---
echo ""
echo -e "${GREEN}============================================${NC}"
echo -e "${GREEN}     ApocalypseOS setup complete!           ${NC}"
echo -e "${GREEN}============================================${NC}"
echo ""
echo "  - Wireless: DISABLED permanently"
echo "  - Firewall: ACTIVE (deny all)"
echo "  - Ollama:   $(command -v ollama &>/dev/null && echo 'INSTALLED' || echo 'NOT INSTALLED')"
echo ""
echo "  Type 'guides' to open offline coding documentation."
echo "  Type 'ollama list' to see your installed models."
echo ""

# Mark setup as complete
touch /etc/apocalypseos-setup-complete
